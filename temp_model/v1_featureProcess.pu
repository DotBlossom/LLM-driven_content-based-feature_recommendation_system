import numpy as np
import pandas as pd
import gc

# ==========================================
# 3. User Features (Enhanced)
# ==========================================
def make_user_features(train_df):
    print("\nğŸ‘¤ [User Stats] Calculating Enhanced Features...")

    # ---------------------------------------
    # 1. Basic Interaction Stats (ê¸°ì¡´ ê°•í™”)
    # ---------------------------------------
    # ì „ì²˜ë¦¬: ë‚ ì§œ ìš”ì¼ íŒŒì•… (0:ì›” ~ 6:ì¼)
    train_df['day_of_week'] = train_df['t_dat'].dt.dayofweek
    train_df['is_weekend'] = (train_df['day_of_week'] >= 5).astype(np.int8)
    
    # Month ì •ë³´ (YYYY-MM)
    train_df['month_id'] = train_df['t_dat'].dt.to_period('M')

    # Aggregation
    user_agg = train_df.groupby('customer_id').agg({
        'price': ['mean', 'std', 'last'],  # í‰ê· , í‘œì¤€í¸ì°¨, ë§ˆì§€ë§‰ êµ¬ë§¤ê°€
        'article_id': ['count', 'nunique'], # ì´ êµ¬ë§¤ìˆ˜, ê³ ìœ  ì•„ì´í…œ ìˆ˜
        't_dat': 'max',                     # ë§ˆì§€ë§‰ êµ¬ë§¤ì¼
        'sales_channel_id': 'mean',         # ì±„ë„ ì„ í˜¸ë„
        'is_weekend': 'mean',               # ì£¼ë§ êµ¬ë§¤ ë¹„ìœ¨
        'month_id': 'nunique'               # í™œë™í•œ ë‹¬ì˜ ìˆ˜ (Loyalty)
    })
    
    # ì»¬ëŸ¼ ì´ë¦„ Flatí•˜ê²Œ ë³€ê²½
    user_agg.columns = [
        'user_avg_price', 'price_std', 'last_price',
        'total_cnt', 'unique_item_cnt',
        'last_purchase_date', 'channel_avg', 
        'weekend_ratio', 'active_months'
    ]
    user_agg = user_agg.reset_index()

    # ---------------------------------------
    # 2. Derived Features (Log & Ratio)
    # ---------------------------------------
    print("   âš™ï¸ Generating Derived Features...")
    
    # (1) Price Related
    # ê°€ê²© ë¶„ì‚°ì´ 0ì¸ ê²½ìš°(í•œ ë²ˆ êµ¬ë§¤ ë“±) ëŒ€ë¹„ fillna(0)
    user_agg['price_std'] = user_agg['price_std'].fillna(0).astype(np.float32)
    user_agg['user_avg_price_log'] = np.log1p(user_agg['user_avg_price']).astype(np.float32)
    user_agg['price_std_log'] = np.log1p(user_agg['price_std']).astype(np.float32)
    
    # ìµœê·¼ êµ¬ë§¤ê°€ì™€ í‰ê·  êµ¬ë§¤ê°€ì˜ ì°¨ì´ (ìµœê·¼ ì†Œë¹„ ìˆ˜ì¤€ ë³€í™”)
    user_agg['last_price_diff'] = (user_agg['last_price'] - user_agg['user_avg_price']).astype(np.float32)

    # (2) Activity Related
    user_agg['total_cnt_log'] = np.log1p(user_agg['total_cnt']).astype(np.float32)
    
    # Repurchase Ratio: (1 - ê³ ìœ ì•„ì´í…œ/ì´êµ¬ë§¤) -> ë†’ì„ìˆ˜ë¡ ì¬êµ¬ë§¤ ì„±í–¥ ê°•í•¨
    # total_cntê°€ 0ì¼ ìˆ˜ ì—†ì§€ë§Œ ì•ˆì „ì¥ì¹˜
    user_agg['repurchase_ratio'] = (1.0 - (user_agg['unique_item_cnt'] / user_agg['total_cnt'])).astype(np.float32)
    
    # Recency
    max_date = train_df['t_dat'].max()
    user_agg['recency_days'] = (max_date - user_agg['last_purchase_date']).dt.days
    user_agg['recency_log'] = np.log1p(user_agg['recency_days']).astype(np.float32)

    # (3) Preference Related
    # 1.5 ê¸°ì¤€: 1(ì˜¨ë¼ì¸), 2(ì˜¤í”„ë¼ì¸) ê°€ì • ì‹œ í‰ê· ì´ 1.5 ì´ˆê³¼ë©´ ì˜¤í”„ë¼ì¸ ì„ í˜¸
    user_agg['preferred_channel'] = np.where(user_agg['channel_avg'] > 1.5, 2, 1).astype(np.int8)
    
    # weekend_ratioëŠ” ì´ë¯¸ 0~1 ì‚¬ì´ ê°’ (float32)
    user_agg['weekend_ratio'] = user_agg['weekend_ratio'].astype(np.float32)
    user_agg['active_months'] = user_agg['active_months'].astype(np.int16) # ê°œì›” ìˆ˜ëŠ” ì‘ìœ¼ë¯€ë¡œ int16

    # ---------------------------------------
    # 3. Dummy Metadata (ìš”ì²­ì‚¬í•­)
    # ---------------------------------------
    print("   ğŸ­ Injecting Dummy Metadata...")
    
    num_users = len(user_agg)
    
    # Age Group: 0~6 (10ëŒ€~70ëŒ€ ê°€ì •, 0ì€ ê²°ì¸¡ì¹˜)
    # ì‹¤ì œë¡œëŠ” customers.csvë¥¼ merge í•´ì•¼ í•¨
    user_agg['age_group_dummy'] = np.random.randint(1, 7, size=num_users).astype(np.int8)
    
    # Gender: 0, 1 (ì—¬ì„±/ë‚¨ì„± ê°€ì •)
    user_agg['gender_dummy'] = np.random.randint(0, 2, size=num_users).astype(np.int8)

    # ---------------------------------------
    # 4. Final Selection & Save
    # ---------------------------------------
    final_cols = [
        'customer_id', 
        # --- Continuous (Normalize í•„ìš”) ---
        'user_avg_price_log', 'price_std_log', 'last_price_diff',
        'total_cnt_log', 'recency_log', 'repurchase_ratio', 'weekend_ratio',
        # --- Categorical / Ordinal (Embedding í•„ìš”) ---
        'preferred_channel', 'active_months', 
        'age_group_dummy', 'gender_dummy'
    ]
    
    final_df = user_agg[final_cols].fillna(0)
    
    print(f"   âœ… Final User Features Shape: {final_df.shape}")
    save_dataframe(final_df, USER_FEAT_PATH_PQ, USER_FEAT_PATH_JS)
    
    return final_df